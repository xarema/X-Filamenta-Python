{% extends "layouts/base.html" %}
{% block title %}Cache Settings - Admin{% endblock %}
{% block content %}
<div class="container-fluid py-5">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <h1 class="display-5 fw-bold text-primary">Cache Configuration</h1>
      <p class="text-muted">Manage cache backend and monitor performance</p>
    </div>
  </div>

  <!-- Current Backend Info -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold mb-3">Current Cache Backend</h5>

          <div class="alert alert-info mb-3">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <strong>Backend:</strong>
                <span class="badge bg-primary fs-6">{{ backend }}</span>

                {% if backend == 'redis' %}
                  <span class="text-success ms-2">âœ“ Optimal performance</span>
                {% elif backend == 'filesystem' %}
                  <span class="text-warning ms-2">âš  Good performance</span>
                {% else %}
                  <span class="text-danger ms-2">âš  Not persistent</span>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Backend Info -->
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2"><strong>Type:</strong> {{ info.info.type or backend }}</p>
              {% if info.info.version %}
              <p class="mb-2"><strong>Version:</strong> {{ info.info.version }}</p>
              {% endif %}
            </div>
            <div class="col-md-6">
              {% if info.info.memory %}
              <p class="mb-2"><strong>Memory:</strong> {{ info.info.memory }}</p>
              {% endif %}
              {% if info.info.keys %}
              <p class="mb-2"><strong>Keys:</strong> {{ info.info.keys }}</p>
              {% elif info.info.entries %}
              <p class="mb-2"><strong>Entries:</strong> {{ info.info.entries }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Redis Configuration (if redis backend) -->
  {% if backend == 'redis' or config.backend == 'redis' %}
  <div class="row mb-4">
    <div class="col-lg-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold mb-3">Redis Configuration</h5>

          <form id="redisConfigForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="redis_host" class="form-label">Host</label>
                <input type="text" class="form-control" id="redis_host"
                       value="{{ config.redis_host }}" placeholder="localhost">
              </div>

              <div class="col-md-6">
                <label for="redis_port" class="form-label">Port</label>
                <input type="number" class="form-control" id="redis_port"
                       value="{{ config.redis_port }}" placeholder="6379">
              </div>

              <div class="col-md-6">
                <label for="redis_password" class="form-label">
                  Password <small class="text-muted">(optional)</small>
                </label>
                <input type="password" class="form-control" id="redis_password"
                       value="{{ config.redis_password }}" placeholder="">
              </div>

              <div class="col-md-6">
                <label for="redis_db" class="form-label">Database</label>
                <input type="number" class="form-control" id="redis_db"
                       value="{{ config.redis_db }}" placeholder="0" min="0" max="15">
              </div>
            </div>

            <div class="mt-4">
              <button type="button" class="btn btn-primary" id="testRedisBtn">
                Test Connection
              </button>
              <button type="button" class="btn btn-secondary" id="testRedisAdvancedBtn">
                Test Advanced (Write/Read)
              </button>
            </div>

            <div id="redisTestResult" class="mt-3"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Cache Actions -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold mb-3">Cache Actions</h5>

          <div class="d-flex gap-3">
            <button type="button" class="btn btn-warning" id="clearCacheBtn">
              Clear All Cache
            </button>
            <button type="button" class="btn btn-info" id="refreshStatsBtn">
              Refresh Statistics
            </button>
          </div>

          <div id="actionResult" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Documentation -->
  <div class="row">
    <div class="col-lg-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold mb-3">Documentation</h5>

          <ul class="list-unstyled">
            <li class="mb-2">
              <a href="#" class="text-decoration-none">
                ðŸ“– Cache Architecture Documentation
              </a>
            </li>
            <li class="mb-2">
              <a href="#" class="text-decoration-none">
                ðŸš€ Redis Configuration Guide (cPanel)
              </a>
            </li>
            <li class="mb-2">
              <a href="#" class="text-decoration-none">
                âš¡ Performance Optimization Tips
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Test Redis Connection (Simple)
document.getElementById('testRedisBtn')?.addEventListener('click', function() {
  const btn = this;
  const resultDiv = document.getElementById('redisTestResult');

  const config = {
    host: document.getElementById('redis_host').value,
    port: document.getElementById('redis_port').value,
    password: document.getElementById('redis_password').value,
    db: document.getElementById('redis_db').value
  };

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';

  fetch('/admin/cache/test-redis', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(config)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      resultDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>âœ“ ${data.message}</strong><br>
          Version: ${data.info.version}<br>
          Memory: ${data.info.memory_used}<br>
          Uptime: ${data.info.uptime_days} days<br>
          Clients: ${data.info.connected_clients}
        </div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="alert alert-danger">
          <strong>âœ— ${data.message}</strong>
        </div>
      `;
    }
  })
  .catch(error => {
    resultDiv.innerHTML = `
      <div class="alert alert-danger">Network error: ${error}</div>
    `;
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = 'Test Connection';
  });
});

// Test Redis Advanced
document.getElementById('testRedisAdvancedBtn')?.addEventListener('click', function() {
  const btn = this;
  const resultDiv = document.getElementById('redisTestResult');

  const config = {
    host: document.getElementById('redis_host').value,
    port: document.getElementById('redis_port').value,
    password: document.getElementById('redis_password').value,
    db: document.getElementById('redis_db').value
  };

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';

  fetch('/admin/cache/test-advanced', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(config)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      resultDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>âœ“ ${data.message}</strong><br>
          Write Time: ${data.info.write_time_ms}ms<br>
          Read Time: ${data.info.read_time_ms}ms<br>
          Permissions: ${data.info.permissions}
        </div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="alert alert-danger">
          <strong>âœ— ${data.message}</strong>
        </div>
      `;
    }
  })
  .catch(error => {
    resultDiv.innerHTML = `
      <div class="alert alert-danger">Network error: ${error}</div>
    `;
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = 'Test Advanced (Write/Read)';
  });
});

// Clear Cache
document.getElementById('clearCacheBtn')?.addEventListener('click', function() {
  if (!confirm('Are you sure you want to clear all cache? This may temporarily slow down the application.')) {
    return;
  }

  const btn = this;
  const resultDiv = document.getElementById('actionResult');

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Clearing...';

  fetch('/admin/cache/clear', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'}
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      resultDiv.innerHTML = `
        <div class="alert alert-success">âœ“ ${data.message}</div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="alert alert-danger">âœ— ${data.message}</div>
      `;
    }
  })
  .catch(error => {
    resultDiv.innerHTML = `
      <div class="alert alert-danger">Network error: ${error}</div>
    `;
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = 'Clear All Cache';
  });
});

// Refresh Stats
document.getElementById('refreshStatsBtn')?.addEventListener('click', function() {
  location.reload();
});
</script>
{% endblock %}

