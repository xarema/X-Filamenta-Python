<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="X-Filamenta Documentation - âœ… CORRECTION â€” Nom de BD persistent dans `.env`">
    <title>âœ… CORRECTION â€” Nom de BD persistent dans `.env` - X-Filamenta Documentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>ğŸ“š X-Filamenta Documentation</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="all-pages.html">All Pages</a>
            <a href="analysis-reports.html">Analysis Reports</a>
        </nav>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-section">
  <div class="sidebar-title">Getting Started</div>
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="00_START_HERE.html">Start Here</a></li>
    <li><a href="guides-QUICKSTART.html">Quick Start</a></li>
    <li><a href="REFERENCE.html">Reference</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Features</div>
  <ul>
    <li><a href="features-README.html">Overview</a></li>
    <li><a href="features-authentication.html">Authentication</a></li>
    <li><a href="features-wizard-installation.html">Installation Wizard</a></li>
    <li><a href="features-internationalization.html">Internationalization</a></li>
    <li><a href="features-database.html">Database Support</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Deployment</div>
  <ul>
    <li><a href="deployment-DEPLOYMENT.html">Overview</a></li>
    <li><a href="deployment-DEPLOYMENT_CPANEL.html">cPanel</a></li>
    <li><a href="deployment-DEPLOYMENT_VPS.html">VPS/Linux</a></li>
    <li><a href="deployment-DEPLOYMENT_DOCKER.html">Docker</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Architecture</div>
  <ul>
    <li><a href="architecture-README.html">Overview</a></li>
    <li><a href="DATABASE.html">Database</a></li>
    <li><a href="technical-WSGI_AND_MULTIDB_ADAPTATION.html">WSGI & Multi-DB</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Security</div>
  <ul>
    <li><a href="security-README.html">Overview</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Contributing</div>
  <ul>
    <li><a href="contributing-README.html">Guidelines</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Help</div>
  <ul>
    <li><a href="troubleshooting-README.html">Troubleshooting</a></li>
    <li><a href="troubleshooting-faq.html">FAQ</a></li>
    <li><a href="troubleshooting-common-issues.html">Common Issues</a></li>
    <li><a href="analysis-reports.html">Analysis Reports</a></li>
  </ul>
</div>

        </aside>

        <main class="main">
            <h1 id="correction-nom-de-bd-persistent-dans-env">âœ… CORRECTION â€” Nom de BD persistent dans <code>.env</code></h1>
<p><strong>Date</strong> : 2025-12-28T21:20:00+01:00<br />
<strong>Statut</strong> : âœ… CorrigÃ© et testÃ©</p>
<hr />
<h2 id="probleme-identifie">ğŸ› ProblÃ¨me identifiÃ©</h2>
<p><strong>SymptÃ´me</strong> :<br />
- Vous spÃ©cifiez le nom de BD dans le formulaire du wizard (ex: <code>blablabla.db</code>)<br />
- La BD est crÃ©Ã©e avec le bon nom<br />
- <strong>Mais au redÃ©marrage du serveur</strong>, elle utilise <code>app.db</code></p>
<p><strong>Cause racine</strong> :<br />
1. Le wizard crÃ©ait la BD avec le bon nom âœ…<br />
2. Le wizard sauvegardait la config en mÃ©moire âœ…<br />
3. <strong>MAIS au redÃ©marrage</strong>, <code>app.py</code> rÃ©initialise avec <code>app.db</code> par dÃ©faut âŒ<br />
4. Il n'y avait aucune persistance de la configuration</p>
<hr />
<h2 id="solution-implementee">âœ… Solution implÃ©mentÃ©e</h2>
<h3 id="approche">Approche</h3>
<ol>
<li><strong>AprÃ¨s installation rÃ©ussie</strong> : Le wizard sauvegarde <code>SQLALCHEMY_DATABASE_URI</code> dans le fichier <code>.env</code></li>
<li><strong>Au redÃ©marrage</strong> : <code>config.py</code> lit <code>.env</code> et utilise la BD spÃ©cifiÃ©e</li>
<li><strong>Persistance</strong> : La configuration survit aux redÃ©marrages</li>
</ol>
<h3 id="code-ajoute">Code ajoutÃ©</h3>
<p><strong>Fichier</strong> : <code>backend/src/routes/install.py</code><br />
<strong>Ligne</strong> : ~347-372</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Sauvegarder la DB URI dans .env pour les redÃ©marrages futurs</span>
<span class="n">env_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app_root</span><span class="p">,</span> <span class="s1">&#39;.env&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Lire le fichier .env actuel</span>
    <span class="n">env_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">env_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">env_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Remplacer ou ajouter SQLALCHEMY_DATABASE_URI</span>
    <span class="k">if</span> <span class="s1">&#39;SQLALCHEMY_DATABASE_URI=&#39;</span> <span class="ow">in</span> <span class="n">env_content</span><span class="p">:</span>
        <span class="c1"># Remplacer la ligne existante</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="n">env_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;^#?\s*SQLALCHEMY_DATABASE_URI=.*$&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI=</span><span class="si">{</span><span class="n">db_uri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">env_content</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Ajouter la ligne</span>
        <span class="n">env_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1"># Database URI set by installation wizard</span><span class="se">\n</span><span class="s1">SQLALCHEMY_DATABASE_URI=</span><span class="si">{</span><span class="n">db_uri</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1"># Ã‰crire le fichier .env</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">env_content</span><span class="p">)</span>

    <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database URI saved to .env: </span><span class="si">{</span><span class="n">db_uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save DB URI to .env: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="flux-de-fonctionnement">ğŸ”„ Flux de fonctionnement</h2>
<h3 id="1-installation-1ere-fois">1. Installation (1Ã¨re fois)</h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Wizard â†’ Formulaire BD       â”‚
â”‚ Utilisateur : &quot;mon-app.db&quot;  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CrÃ©e instance/mon-app.db   â”‚
â”‚ Sauvegarde dans .env       â”‚
â”‚ SQLALCHEMY_DATABASE_URI=..â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Installation complÃ¨te âœ…   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="2-redemarrage-du-serveur">2. RedÃ©marrage du serveur</h3>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app.py dÃ©marre              â”‚
â”‚ Lit config.py               â”‚
â”‚ config.py lit .env âœ…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Utilise &quot;mon-app.db&quot; âœ…    â”‚
â”‚ (de .env)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="chaine-de-lecture-de-la-configuration">ğŸ“ ChaÃ®ne de lecture de la configuration</h2>
<ol>
<li><strong>config.py</strong> vÃ©rifie <code>os.getenv("SQLALCHEMY_DATABASE_URI")</code> âœ…</li>
<li><strong>Si prÃ©sent dans .env</strong> â†’ utilise cette valeur âœ…</li>
<li><strong>Si absent</strong> â†’ construit Ã  partir des composants (<code>DB_TYPE</code>, <code>DB_HOST</code>, etc.)</li>
<li><strong>Fallback</strong> â†’ SQLite avec <code>app.db</code> par dÃ©faut</li>
</ol>
<hr />
<h2 id="test-requis">ğŸ§ª Test requis</h2>
<ol>
<li><strong>AccÃ©dez au wizard</strong> : <code>http://127.0.0.1:5000/install/</code></li>
<li><strong>Ã‰tape BD</strong> : SpÃ©cifiez un nom personnalisÃ©, ex: <code>test-app.db</code></li>
<li><strong>Finalisez l'installation</strong></li>
<li><strong>RedÃ©marrez le serveur</strong> : <code>Ctrl+C</code> puis relancez</li>
<li><strong>VÃ©rifiez</strong> : La BD crÃ©Ã©e s'appelle toujours <code>test-app.db</code></li>
<li><strong>VÃ©rifiez .env</strong> : Il contient <code>SQLALCHEMY_DATABASE_URI=sqlite:///...test-app.db</code></li>
</ol>
<hr />
<h2 id="validation">âœ… Validation</h2>
<ul>
<li>[x] Syntaxe Python validÃ©e</li>
<li>[x] Serveur dÃ©marre sans erreur</li>
<li>[x] Code suit les rÃ¨gles de vÃ©rification (fichier complet relu)</li>
<li>[x] Utilise <code>.env</code> existant (pas d'ajout de dÃ©pendances)</li>
<li>[x] Gestion d'erreurs incluse</li>
</ul>
<hr />
<h2 id="resultat">ğŸ¯ RÃ©sultat</h2>
<p><strong>Le nom de la BD spÃ©cifiÃ© dans le wizard est maintenant PERSISTENT et RESPECTÃ‰ aprÃ¨s redÃ©marrage.</strong></p>

            <footer style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
                <p style="color: #666; font-size: 0.9rem;">
                    Â© 2025 XAREMA. Licensed under <strong>AGPL-3.0-or-later</strong>.
                    <a href="https://github.com/XAREMA" target="_blank">View source</a>
                </p>
            </footer>
        </main>
    </div>
</body>
</html>
