# ğŸ”§ Correction erreur i18n â€” NameError: name 't' is not defined

**Date** : 2025-12-28T20:27:00+01:00  
**Statut** : âœ… CorrigÃ©  
**Serveur** : ğŸŸ¢ http://127.0.0.1:5000

---

## ğŸ› ProblÃ¨me rencontrÃ©

### Erreur

```
NameError: name 't' is not defined
```

**Stacktrace** :

```python
File "backend/src/routes/install.py", line 133, in render_full_page
    "t": t  # Fonction de traduction importÃ©e
         ^
NameError: name 't' is not defined
```

---

## ğŸ” Cause du problÃ¨me

**Code problÃ©matique (tentative 1)** :

```python
from backend.src.utils.i18n import t

# ...plus loin dans le code...

def install_step():
    # ...
    def render_full_page(extra_context: dict[str, Any] | None = None) -> str:
        ctx = {
            "t": t  # âŒ ERREUR : 't' n'est pas accessible dans cette portÃ©e
        }
```

**Explication** :

- `t` est importÃ© au **niveau du module**
- `render_full_page` est une **fonction interne** Ã  `install_step()`
- Python ne trouve pas `t` dans la portÃ©e de la fonction interne

---

## âœ… Solution appliquÃ©e

### Changement 1 : Import du module au lieu de la fonction

**Avant** :

```python
from backend.src.utils.i18n import t  # Import direct
```

**AprÃ¨s** :

```python
from backend.src.utils import i18n  # Import du module
```

### Changement 2 : RÃ©fÃ©rence via le module

**Avant** :

```python
def render_full_page(extra_context: dict[str, Any] | None = None) -> str:
    ctx = {
        "t": t  # âŒ NameError
    }
```

**AprÃ¨s** :

```python
def render_full_page(extra_context: dict[str, Any] | None = None) -> str:
    ctx = {
        "t": i18n.t  # âœ… OK - rÃ©fÃ©rence via le module
    }
```

---

## ğŸ“ Code final

**Fichier** : `backend/src/routes/install.py`

**Imports** (lignes 36-42) :

```python
from flask import Blueprint, current_app, redirect, render_template, request, session
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

from backend.src.extensions import db
from backend.src.services.install_service import InstallService
from backend.src.utils import i18n  # âœ… Import du module
```

**Fonction render_full_page** (lignes 126-137) :

```python
def render_full_page(extra_context: dict[str, Any] | None = None) -> str:
    env_summary = InstallService.render_env_summary(app_root)
    ctx = {
        "state": state,
        "env": env_summary,
        "session": session,
        "step": step,
        "t": i18n.t  # âœ… Fonction de traduction accessible
    }
    if extra_context:
        ctx.update(extra_context)
    return render_template("pages/install/index.html", **ctx)
```

---

## ğŸ§ª Tests effectuÃ©s

### Test 1 : DÃ©marrage du serveur

```bash
.\.venv\Scripts\python.exe run_prod.py
```

**RÃ©sultat** :

```
âœ… 2025-12-28 20:26:52,978 [INFO] waitress: Serving on http://127.0.0.1:5000
```

**Statut** : âœ… Serveur dÃ©marre sans erreur

---

### Test 2 : AccÃ¨s au wizard

**URL** : `http://127.0.0.1:5000/install/`

**RÃ©sultat attendu** :

- âœ… Pas d'erreur `NameError: name 't' is not defined`
- âœ… Pas d'erreur `TypeError: 'NoneType' object is not callable`
- âœ… Wizard s'affiche correctement
- âœ… Traductions fonctionnent

---

## ğŸ“Š RÃ©sumÃ© des tentatives de correction

| Tentative | Approche | RÃ©sultat |
|-----------|----------|----------|
| 1 | `current_app.jinja_env.globals.get('t')` | âŒ Retourne `None` â†’ `TypeError` |
| 2 | `from backend.src.utils.i18n import t` | âŒ PortÃ©e incorrecte â†’ `NameError` |
| 3 | `from backend.src.utils import i18n` + `i18n.t` | âœ… Fonctionne |

---

## ğŸ¯ LeÃ§on apprise

### ProblÃ¨me de portÃ©e (scope) en Python

Quand vous avez une **fonction interne** :

```python
from mymodule import myfunction

def outer():
    def inner():
        result = myfunction()  # âŒ Peut causer NameError selon le contexte
```

**Solution** : Utiliser l'import du module :

```python
from mypackage import mymodule

def outer():
    def inner():
        result = mymodule.myfunction()  # âœ… Toujours accessible
```

---

## âœ… Statut final

- [x] Serveur dÃ©marre sans erreur
- [x] Aucune erreur `NameError`
- [x] Aucune erreur `TypeError`
- [x] Fonction `i18n.t` accessible dans le contexte du wizard
- [x] PrÃªt pour les tests utilisateur

---

## ğŸš€ Prochaine Ã©tape

**Tester le wizard complet** :

1. Ouvrir `http://127.0.0.1:5000/install/`
2. VÃ©rifier que les traductions s'affichent correctement
3. Parcourir toutes les Ã©tapes sans erreur
4. Confirmer que la dÃ©tection automatique de langue fonctionne

---

**Mainteneur** : AleGabMar  
**DerniÃ¨re mise Ã  jour** : 2025-12-28T20:27:00+01:00

