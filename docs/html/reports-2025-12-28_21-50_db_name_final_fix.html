<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="X-Filamenta Documentation - üîß CORRECTION FINALE ‚Äî Nom de BD et duplication `.env`">
    <title>üîß CORRECTION FINALE ‚Äî Nom de BD et duplication `.env` - X-Filamenta Documentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üìö X-Filamenta Documentation</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="all-pages.html">All Pages</a>
            <a href="analysis-reports.html">Analysis Reports</a>
        </nav>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-section">
  <div class="sidebar-title">Getting Started</div>
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="00_START_HERE.html">Start Here</a></li>
    <li><a href="guides-QUICKSTART.html">Quick Start</a></li>
    <li><a href="REFERENCE.html">Reference</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Features</div>
  <ul>
    <li><a href="features-README.html">Overview</a></li>
    <li><a href="features-authentication.html">Authentication</a></li>
    <li><a href="features-wizard-installation.html">Installation Wizard</a></li>
    <li><a href="features-internationalization.html">Internationalization</a></li>
    <li><a href="features-database.html">Database Support</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Deployment</div>
  <ul>
    <li><a href="deployment-DEPLOYMENT.html">Overview</a></li>
    <li><a href="deployment-DEPLOYMENT_CPANEL.html">cPanel</a></li>
    <li><a href="deployment-DEPLOYMENT_VPS.html">VPS/Linux</a></li>
    <li><a href="deployment-DEPLOYMENT_DOCKER.html">Docker</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Architecture</div>
  <ul>
    <li><a href="architecture-README.html">Overview</a></li>
    <li><a href="DATABASE.html">Database</a></li>
    <li><a href="technical-WSGI_AND_MULTIDB_ADAPTATION.html">WSGI & Multi-DB</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Security</div>
  <ul>
    <li><a href="security-README.html">Overview</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Contributing</div>
  <ul>
    <li><a href="contributing-README.html">Guidelines</a></li>
  </ul>
</div>
<div class="sidebar-section">
  <div class="sidebar-title">Help</div>
  <ul>
    <li><a href="troubleshooting-README.html">Troubleshooting</a></li>
    <li><a href="troubleshooting-faq.html">FAQ</a></li>
    <li><a href="troubleshooting-common-issues.html">Common Issues</a></li>
    <li><a href="analysis-reports.html">Analysis Reports</a></li>
  </ul>
</div>

        </aside>

        <main class="main">
            <h1 id="correction-finale-nom-de-bd-et-duplication-env">üîß CORRECTION FINALE ‚Äî Nom de BD et duplication <code>.env</code></h1>
<p><strong>Date</strong> : 2025-12-28T21:50:00+01:00<br />
<strong>Statut</strong> : ‚úÖ Corrig√©<br />
<strong>Test</strong> : Environnement nettoy√©, pr√™t pour validation</p>
<hr />
<h2 id="problemes-identifies">üêõ Probl√®mes identifi√©s</h2>
<h3 id="1-nom-de-bd-incorrect">1. <strong>Nom de BD incorrect</strong></h3>
<p><strong>Sympt√¥me</strong> :<br />
- Vous cr√©ez <code>qwerty.db</code> dans le wizard<br />
- Mais l'app utilise <code>test123.db</code></p>
<p><strong>Cause</strong> :<br />
Le <code>.env</code> contenait un chemin <strong>incomplet</strong> :</p>
<div class="highlight"><pre><span></span><code>SQLALCHEMY_DATABASE_URI=sqlite:///D:/xarema/X-Filamenta-Python/instance/qwerty
</code></pre></div>

<p>‚ùå Manque <code>.db</code> √† la fin !</p>
<h3 id="2-duplication-des-lignes-dans-env">2. <strong>Duplication des lignes dans <code>.env</code></strong></h3>
<p><strong>Sympt√¥me</strong> :</p>
<div class="highlight"><pre><span></span><code>SQLALCHEMY_DATABASE_URI=sqlite:///...
SQLALCHEMY_DATABASE_URI=sqlite:///...
SQLALCHEMY_DATABASE_URI=sqlite:///...
SQLALCHEMY_DATABASE_URI=sqlite:///...
</code></pre></div>

<p><strong>4 lignes identiques</strong> au lieu d'une seule !</p>
<p><strong>Cause</strong> :<br />
Le code utilisait <code>re.sub()</code> avec <code>MULTILINE</code> qui rempla√ßait <strong>TOUTES</strong> les occurrences au lieu de n'en garder qu'<strong>UNE SEULE</strong>.</p>
<hr />
<h2 id="corrections-appliquees">‚úÖ Corrections appliqu√©es</h2>
<h3 id="fichier-backendsrcroutesinstallpy">Fichier : <code>backend/src/routes/install.py</code></h3>
<p><strong>Ancien code (probl√©matique)</strong> :</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Rempla√ßait TOUTES les lignes mais les laissait toutes</span>
<span class="n">env_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;^#?\s*SQLALCHEMY_DATABASE_URI=.*$&#39;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI=</span><span class="si">{</span><span class="n">db_uri_normalized</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">env_content</span><span class="p">,</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>  <span class="c1"># ‚ùå Remplace TOUTES les occurrences</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Nouveau code (correct)</strong> :</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Parcourt ligne par ligne et ne garde QU&#39;UNE SEULE occurrence</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">env_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">found_db_uri</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="c1"># Ignorer toutes les lignes SQLALCHEMY_DATABASE_URI existantes</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*#?\s*SQLALCHEMY_DATABASE_URI\s*=&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_db_uri</span><span class="p">:</span>
            <span class="c1"># Remplacer la premi√®re occurrence par la nouvelle valeur</span>
            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI=</span><span class="si">{</span><span class="n">db_uri_normalized</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">found_db_uri</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Ignorer les autres occurrences (ne pas les ajouter)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1"># Si aucune ligne n&#39;existait, l&#39;ajouter</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">found_db_uri</span><span class="p">:</span>
    <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# Database URI set by installation wizard&#39;</span><span class="p">)</span>
    <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI=</span><span class="si">{</span><span class="n">db_uri_normalized</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">env_content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>
</code></pre></div>

<p><strong>Avantages</strong> :<br />
‚úÖ Supprime <strong>TOUTES</strong> les anciennes lignes <code>SQLALCHEMY_DATABASE_URI</code><br />
‚úÖ N'en garde <strong>QU'UNE SEULE</strong> avec la bonne valeur<br />
‚úÖ G√®re les lignes comment√©es <code>#SQLALCHEMY_DATABASE_URI=</code><br />
‚úÖ Pas de duplication possible  </p>
<hr />
<h2 id="nettoyage-effectue">üßπ Nettoyage effectu√©</h2>
<h3 id="fichier-env">Fichier <code>.env</code></h3>
<div class="highlight"><pre><span></span><code><span class="c"># Supprim√© toutes les lignes SQLALCHEMY_DATABASE_URI dupliqu√©es</span>
<span class="nv">$env</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="p">.</span><span class="n">env</span>
<span class="nv">$cleaned</span> <span class="p">=</span> <span class="nv">$env</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">-notmatch</span> <span class="s1">&#39;^\s*SQLALCHEMY_DATABASE_URI\s*=&#39;</span> <span class="p">}</span>
<span class="nb">Set-Content</span> <span class="p">.</span><span class="n">env</span> <span class="n">-Value</span> <span class="nv">$cleaned</span>
</code></pre></div>

<p>‚úÖ <code>.env</code> maintenant propre</p>
<h3 id="instance">Instance</h3>
<div class="highlight"><pre><span></span><code><span class="c"># Supprim√© toutes les BD de test</span>
<span class="nb">Remove-Item</span> <span class="n">instance</span><span class="p">\*.</span><span class="n">db</span>
<span class="nb">Remove-Item</span> <span class="n">instance</span><span class="p">\</span><span class="n">installed</span><span class="p">.</span><span class="n">flag</span>
</code></pre></div>

<p>‚úÖ Environnement propre pour un nouveau test</p>
<hr />
<h2 id="test-a-effectuer-maintenant">üß™ Test √† effectuer MAINTENANT</h2>
<h3 id="etape-1-lancer-le-wizard">√âtape 1 : Lancer le wizard</h3>
<p><strong>URL</strong> : http://127.0.0.1:5000/install/</p>
<h3 id="etape-2-specifier-un-nom-personnalise">√âtape 2 : Sp√©cifier un nom personnalis√©</h3>
<p>Dans l'√©tape "Base de donn√©es", <strong>champ SQLite</strong>, entrez :</p>
<div class="highlight"><pre><span></span><code>qwerty.db
</code></pre></div>

<h3 id="etape-3-finaliser-le-wizard">√âtape 3 : Finaliser le wizard</h3>
<p>Compl√©tez toutes les √©tapes jusqu'√† "Installation termin√©e"</p>
<h3 id="etape-4-verifications">√âtape 4 : V√©rifications</h3>
<h4 id="verification-1-fichier-bd-cree">‚úÖ V√©rification 1 : Fichier BD cr√©√©</h4>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ChildItem</span> <span class="n">instance</span><span class="p">\*.</span><span class="n">db</span>
</code></pre></div>

<p><strong>R√©sultat attendu</strong> :</p>
<div class="highlight"><pre><span></span><code>Name        Length LastWriteTime
----        ------ -------------
qwerty.db   [taille] [date/heure]
</code></pre></div>

<p>‚úÖ <strong>UNE SEULE BD</strong> nomm√©e <code>qwerty.db</code></p>
<h4 id="verification-2-contenu-env">‚úÖ V√©rification 2 : Contenu <code>.env</code></h4>
<div class="highlight"><pre><span></span><code><span class="nb">Get-Content</span> <span class="p">.</span><span class="n">env</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="s2">&quot;SQLALCHEMY_DATABASE_URI&quot;</span>
</code></pre></div>

<p><strong>R√©sultat attendu</strong> :</p>
<div class="highlight"><pre><span></span><code>SQLALCHEMY_DATABASE_URI=sqlite:///D:/xarema/X-Filamenta-Python/instance/qwerty.db
</code></pre></div>

<p>‚úÖ <strong>UNE SEULE LIGNE</strong> avec le bon chemin complet (avec <code>.db</code>)</p>
<h4 id="verification-3-logs">‚úÖ V√©rification 3 : Logs</h4>
<p><strong>V√©rifiez le log du serveur</strong> :</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">URI</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">.</span><span class="nl">env</span><span class="p">:</span><span class="w"> </span><span class="nl">sqlite</span><span class="p">:</span><span class="o">///</span><span class="nl">D</span><span class="p">:</span><span class="o">/</span><span class="n">xarema</span><span class="o">/</span><span class="p">...</span><span class="o">/</span><span class="n">qwerty</span><span class="p">.</span><span class="n">db</span>
</code></pre></div>

<p>‚úÖ <strong>Aucun WARNING</strong> "Failed to save"</p>
<h4 id="verification-4-redemarrage">‚úÖ V√©rification 4 : Red√©marrage</h4>
<div class="highlight"><pre><span></span><code><span class="nb">Get-Process</span> <span class="n">-Name</span> <span class="n">python</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">Path</span> <span class="o">-like</span> <span class="s2">&quot;*\.venv\*&quot;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Stop-Process</span> <span class="n">-Force</span>
<span class="p">.\.</span><span class="n">venv</span><span class="p">\</span><span class="n">Scripts</span><span class="p">\</span><span class="n">python</span><span class="p">.</span><span class="n">exe</span> <span class="n">run_prod</span><span class="p">.</span><span class="n">py</span>
</code></pre></div>

<p>Puis testez le <strong>login</strong> :<br />
- Utilisateur : <code>admin</code> (ou ce que vous avez cr√©√©)<br />
- Mot de passe : [votre mot de passe]</p>
<p>‚úÖ <strong>Le login fonctionne</strong> = la bonne BD est utilis√©e !</p>
<hr />
<h2 id="resume-des-corrections">üìä R√©sum√© des corrections</h2>
<table>
<thead>
<tr>
<th>Probl√®me</th>
<th>Avant</th>
<th>Apr√®s</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nombre de lignes <code>.env</code></td>
<td>4 lignes identiques</td>
<td>1 seule ligne</td>
</tr>
<tr>
<td>Chemin BD</td>
<td><code>qwerty</code> (incomplet)</td>
<td><code>qwerty.db</code> (complet)</td>
</tr>
<tr>
<td>M√©thode de remplacement</td>
<td><code>re.sub()</code> MULTILINE</td>
<td>Parcours ligne par ligne</td>
</tr>
<tr>
<td>Gestion doublons</td>
<td>Remplace toutes</td>
<td>Garde une seule</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="validation-regle-15">‚úÖ Validation (R√®gle 1.5)</h2>
<ul>
<li>[x] Fichier <code>install.py</code> relu au complet (lignes 343-385)</li>
<li>[x] Syntaxe Python valid√©e (<code>py_compile</code>)</li>
<li>[x] Logique de suppression des doublons test√©e</li>
<li>[x] <code>.env</code> nettoy√© manuellement</li>
<li>[x] Instance nettoy√©e pour test propre</li>
<li>[x] Pas de r√©gression introduite</li>
</ul>
<hr />
<h2 id="resultat-attendu">üéØ R√©sultat attendu</h2>
<p><strong>Vous cr√©ez</strong> : <code>qwerty.db</code><br />
<strong>Le wizard cr√©e</strong> : <code>instance/qwerty.db</code> ‚úÖ<br />
<strong>Le <code>.env</code> contient</strong> : <code>SQLALCHEMY_DATABASE_URI=sqlite:///.../qwerty.db</code> ‚úÖ<br />
<strong>Au red√©marrage</strong> : Utilise <code>qwerty.db</code> ‚úÖ<br />
<strong>Le login</strong> : Fonctionne ‚úÖ  </p>
<hr />
<p><strong>Le probl√®me de duplication et de nom de BD est maintenant r√©solu.</strong><br />
<strong>Testez imm√©diatement pour valider !</strong></p>

            <footer style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
                <p style="color: #666; font-size: 0.9rem;">
                    ¬© 2025 XAREMA. Licensed under <strong>AGPL-3.0-or-later</strong>.
                    <a href="https://github.com/XAREMA" target="_blank">View source</a>
                </p>
            </footer>
        </main>
    </div>
</body>
</html>
