{% extends "layouts/base.html" %} {% block title %}{{ t('admin.settings.title') }} - {{
t('app.name') }}{% endblock %} {% block content %}
<div class="container-fluid py-5">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <h1 class="display-5 fw-bold text-primary">{{ t('admin.settings.title') }}</h1>
      <p class="text-muted">{{ t('admin.settings.subtitle') }}</p>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Settings Form -->
  <div class="row">
    <div class="col-lg-8">
      <form method="POST" action="{{ url_for('admin.settings') }}">

        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <!-- SMTP Configuration Section -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">{{ t('admin.settings.email.title') }}</h5>
          </div>
          <div class="card-body p-4">
            <!-- SMTP Host -->
            <div class="mb-3">
              <label for="smtpHost" class="form-label fw-bold">
                {{ t('admin.settings.email.smtp_host') }}
              </label>
              <input
                type="text"
                class="form-control"
                id="smtpHost"
                name="smtp_host"
                value="{{ settings.get('smtp_host', 'smtp.mailtrap.io') }}"
                placeholder="smtp.mailtrap.io"
              />
            </div>

            <!-- SMTP Port -->
            <div class="mb-3">
              <label for="smtpPort" class="form-label fw-bold">
                {{ t('admin.settings.email.smtp_port') }}
              </label>
              <input
                type="number"
                class="form-control"
                id="smtpPort"
                name="smtp_port"
                value="{{ settings.get('smtp_port', '465') }}"
                placeholder="465"
              />
            </div>

            <!-- SMTP User -->
            <div class="mb-3">
              <label for="smtpUser" class="form-label fw-bold">
                {{ t('admin.settings.email.smtp_user') }}
              </label>
              <input
                type="text"
                class="form-control"
                id="smtpUser"
                name="smtp_user"
                value="{{ settings.get('smtp_user', '') }}"
                placeholder="votre-utilisateur"
              />
            </div>

            <!-- SMTP Password -->
            <div class="mb-3">
              <label for="smtpPassword" class="form-label fw-bold">
                {{ t('admin.settings.email.smtp_password') }}
              </label>
              <input
                type="password"
                class="form-control"
                id="smtpPassword"
                name="smtp_password"
                placeholder="Entrez le mot de passe (chiffrÃ©)"
              />
            </div>

            <!-- SMTP TLS -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="smtpTLS"
                  name="smtp_tls_enabled"
                  {% if settings.get('smtp_tls_enabled', True) %}checked{% endif %}
                />
                <label class="form-check-label" for="smtpTLS">
                  {{ t('admin.settings.email.smtp_tls') }}
                </label>
              </div>
            </div>

            <!-- SMTP From Email -->
            <div class="mb-3">
              <label for="smtpFromEmail" class="form-label fw-bold">
                {{ t('admin.settings.email.from_email') }}
              </label>
              <input
                type="email"
                class="form-control"
                id="smtpFromEmail"
                name="smtp_from_email"
                value="{{ settings.get('smtp_from_email', 'noreply@example.com') }}"
                placeholder="noreply@example.com"
              />
            </div>

            <!-- Test SMTP Button -->
            <button type="button" class="btn btn-outline-primary" id="testSmtpBtn">
              {{ t('admin.settings.test_smtp') or 'Tester la connexion' }}
            </button>
            <div id="smtpTestResult" class="mt-3"></div>
          </div>
        </div>

        <!-- Email Verification Section -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">{{ t('admin.settings.email.title') }} - {{ t('common.next') }}</h5>
          </div>
          <div class="card-body p-4">
            <!-- Email Verification Required -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="emailVerificationRequired"
                  name="email_verification_required"
                  {% if settings.get('email_verification_required', False) %}checked{% endif %}
                />
                <label class="form-check-label" for="emailVerificationRequired">
                  {{ t('admin.settings.email.verification_required') }}
                </label>
              </div>
            </div>

            <!-- Email Verification Expiry -->
            <div class="mb-3">
              <label for="emailVerificationExpiry" class="form-label fw-bold">
                {{ t('admin.settings.email.verification_expiry') }}
              </label>
              <input
                type="number"
                class="form-control"
                id="emailVerificationExpiry"
                name="email_verification_token_expiry_hours"
                value="{{ settings.get('email_verification_token_expiry_hours', '24') }}"
                min="1"
              />
            </div>

            <!-- Password Reset Expiry -->
            <div class="mb-3">
              <label for="passwordResetExpiry" class="form-label fw-bold">
                {{ t('admin.settings.password.reset_expiry') }}
              </label>
              <input
                type="number"
                class="form-control"
                id="passwordResetExpiry"
                name="password_reset_token_expiry_minutes"
                value="{{ settings.get('password_reset_token_expiry_minutes', '60') }}"
                min="5"
              />
            </div>

            <!-- Password Reset Rate Limit -->
            <div class="mb-3">
              <label for="passwordResetLimit" class="form-label fw-bold">
                {{ t('admin.settings.password.reset_rate_limit') }}
              </label>
              <input
                type="number"
                class="form-control"
                id="passwordResetLimit"
                name="password_reset_rate_limit_per_hour"
                value="{{ settings.get('password_reset_rate_limit_per_hour', '2') }}"
                min="1"
              />
            </div>
          </div>
        </div>

        <!-- Feature Flags Section -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">{{ t('admin.settings.security.title') }}</h5>
          </div>
          <div class="card-body p-4">
            <!-- Registration Enabled -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="registrationEnabled"
                  name="registration_enabled"
                  {% if settings.get('registration_enabled', False) %}checked{% endif %}
                />
                <label class="form-check-label" for="registrationEnabled">
                  {{ t('admin.settings.security.registration_enabled') }}
                </label>
              </div>
            </div>

            <!-- 2FA Required -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="2faRequired"
                  name="2fa_required"
                  {% if settings.get('2fa_required', False) %}checked{% endif %}
                />
                <label class="form-check-label" for="2faRequired">
                  {{ t('admin.settings.security.2fa_required') }}
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="d-grid gap-2 mb-4">
          <button type="submit" class="btn btn-primary btn-lg">
            {{ t('common.save') }}
          </button>
        </div>
      </form>
    </div>

    <!-- Info Sidebar -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-3">{{ t('common.loading') }}</h5>

          <dl class="row mb-0">
            <dt class="col-sm-6 text-muted">{{ t('app.version') }}:</dt>
            <dd class="col-sm-6"><code>{{ t('app.version') }}</code></dd>

            <dt class="col-sm-6 text-muted">API:</dt>
            <dd class="col-sm-6"><code>1.0</code></dd>

            <dt class="col-sm-6 text-muted">{{ t('wizard.requirements.environment') }}:</dt>
            <dd class="col-sm-6">{{ config.ENV or 'production' }}</dd>

            <dt class="col-sm-6 text-muted">Status:</dt>
            <dd class="col-sm-6">
              <span class="badge bg-success">Online</span>
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Test SMTP Script -->
<script>
document.getElementById('testSmtpBtn').addEventListener('click', function() {
  const btn = this;
  const resultDiv = document.getElementById('smtpTestResult');

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ t("common.loading") }}';

  fetch('{{ url_for("admin.test_smtp_settings") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    const alertClass = data.success ? 'alert-success' : 'alert-danger';
    resultDiv.innerHTML = `<div class="alert ${alertClass}">${data.message}</div>`;
  })
  .catch(error => {
    resultDiv.innerHTML = `<div class="alert alert-danger">{{ t("common.error") }}: ${error}</div>`;
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = '{{ t("auth.register.test_smtp") }}';
  });
});
</script>
{% endblock %}
