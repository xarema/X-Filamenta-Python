{% extends "layouts/admin.html" %}

{% block title %}Gestion des Traductions - Admin{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
<style>
    .tabulator {
        font-size: 0.9rem;
        border: none !important;
    }
    .tabulator-header {
        background-color: #f8f9fc !important;
        color: #4e73df !important;
        font-weight: bold;
    }
    .tabulator-cell {
        padding: 12px !important;
    }
    .tabulator-row:nth-child(even) {
        background-color: #f8f9fc;
    }
    .tabulator-row-editing {
        background-color: #fff3cd !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Gestion des Traductions</h1>
            <p class="text-muted mb-0">Interface d'édition en temps réel des fichiers de langue.</p>
        </div>
        <div class="mt-3 mt-sm-0">
            <div class="btn-group shadow-sm">
                <select id="lang-select" class="form-select border-0 shadow-none bg-white" style="border-radius: 0.35rem 0 0 0.35rem;">
                    {% for code, name in languages.items() %}
                        {% if code == 'fr' %}
                            <option value="{{ code }}" selected>{{ name }} ({{ code }})</option>
                        {% else %}
                            <option value="{{ code }}">{{ name }} ({{ code }})</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <button id="refresh-btn" class="btn btn-white border-start" title="Actualiser les données">
                    <i class="fas fa-sync-alt text-primary"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats summary (optional but nice) -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total des clés</div>
                            <div id="total-keys" class="h5 mb-0 font-weight-bold text-gray-800">Chargement...</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-language fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Table Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Éditeur de traductions</h6>
            <div class="input-group input-group-sm w-50">
                <span class="input-group-text bg-light border-0"><i class="fas fa-search text-gray-400"></i></span>
                <input type="text" id="search-input" class="form-control bg-light border-0 small" placeholder="Rechercher une clé ou un texte..." aria-label="Search">
            </div>
        </div>
        <div class="card-body p-0">
            <div id="translations-table"></div>
        </div>
    </div>

    <!-- Toast for notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="saveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Traduction enregistrée avec succès !
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script>
    let table;
    const langSelect = document.getElementById('lang-select');
    const searchInput = document.getElementById('search-input');
    const refreshBtn = document.getElementById('refresh-btn');
    const totalKeysDisplay = document.getElementById('total-keys');
    const toastElement = document.getElementById('saveToast');
    const saveToast = new bootstrap.Toast(toastElement);

    function initTable(lang) {
        table = new Tabulator("#translations-table", {
            ajaxURL: `/admin/i18n/api/translations/${lang}`,
            layout: "fitColumns",
            pagination: "local",
            paginationSize: 50,
            paginationSizeSelector: [20, 50, 100, 500],
            placeholder: "Aucune donnée trouvée",
            columns: [
                {title: "Clé i18n", field: "key", widthGrow: 1.5, sorter: "string", headerFilter: false},
                {title: "Texte de traduction", field: "value", widthGrow: 3, editor: "textarea", sorter: "string",
                    formatter: "textarea", cellEdited: function(cell) {
                        const data = cell.getRow().getData();
                        updateTranslation(langSelect.value, data.key, data.value);
                    }
                },
            ],
            dataLoaded: function(data) {
                totalKeysDisplay.textContent = data.length;
            },
        });
    }

    function updateTranslation(lang, key, value) {
        fetch(`/admin/i18n/api/translations/${lang}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ key, value }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveToast.show();
            } else {
                alert('Erreur lors de la mise à jour : ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur réseau lors de la mise à jour');
        });
    }

    langSelect.addEventListener('change', (e) => {
        const lang = e.target.value;
        table.setData(`/admin/i18n/api/translations/${lang}`);
    });

    searchInput.addEventListener('keyup', (e) => {
        const value = e.target.value;
        table.setFilter([
            [
                {field: "key", type: "like", value: value},
                {field: "value", type: "like", value: value}
            ]
        ]);
    });

    refreshBtn.addEventListener('click', () => {
        const lang = langSelect.value;
        table.setData(`/admin/i18n/api/translations/${lang}`);
    });

    document.addEventListener('DOMContentLoaded', () => {
        initTable(langSelect.value);
    });
</script>
{% endblock %}
