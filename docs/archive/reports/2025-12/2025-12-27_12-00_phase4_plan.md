<!--
Purpose: Phase 4 execution plan
Description: Sequenced plan to deliver Phase 4 backlog items with tests and security notes

File: Analysis_reports/2025-12-27_12-00_phase4_plan.md | Repository: X-Filamenta-Python
Created: 2025-12-27T12:00:00+00:00
Last modified (Git): TBD | Commit: TBD

Distributed by: XAREMA | Coder: AleGabMar
App version: 0.0.1-Alpha | File version: 0.0.1-Alpha

License: AGPL-3.0-or-later
SPDX-License-Identifier: AGPL-3.0-or-later

Copyright (c) 2025 XAREMA. All rights reserved.

Metadata:
- Status: Draft
- Classification: Internal
  Notes:
- Git history is the source of truth for authorship and change tracking.
- If generated: "Generated file — do not edit by hand."
-->

# Phase 4 plan — X-Filamenta-Python (2025-12-27 12:00 UTC)

## Contexte / objectif
Poursuivre la Phase 4 du roadmap (.roadmap/ROADMAP.md) : finaliser le wizard restore/seed, poser l'auth HTMX avec 2FA optionnel, sécuriser la session, introduire les modèles User/Theme/Content avec migrations et CRUD admin, et préparer le pipeline backup/restore + footer attribution.

## Portée
- Wizard installation: restore/seed réel (manifest+checksum), progression visuelle, erreurs explicites, retrait du test de padding après couverture.
- Auth HTMX: login/logout, throttling, politique mot de passe forte réutilisée, 2FA TOTP optionnel.
- Session sécurisée: cookies HttpOnly/SameSite, CSRF pour formulaires non-HTMX, rate-limit login/2FA.
- Modèles/migrations: User (roles/langue/theme/totp_secret), Theme, Content; services et routes CRUD admin + templates.
- Backup/restore pipeline: génération backup (manifest+checksum), snapshot pré-restore, dry-run; footer attribution AGPL vérifiée.

## Plan séquencé (incréments courts)
1) Wizard restore/seed
- Mapper flux existant et compléter logique: lecture manifest, vérif checksum, snapshot avant restore, seed réel.
- Ajouter états de progression HTMX + erreurs explicites; retirer test de padding une fois la couverture renforcée.
- Tests: `backend/tests/test_install_wizard.py` (happy/error), HTMX fragments.

2) Auth HTMX minimale
- Créer blueprint auth (`backend/src/routes/auth.py`), fragments login/logout HTMX, réutiliser validateur mot de passe fort.
- Throttling sur login, messages erreurs clairs; test client HTMX (`backend/tests/test_routes.py`).

3) Session sécurisée
- Configurer cookies (HttpOnly, SameSite=Lax/Strict selon besoin), CSRF pour formulaires non-HTMX, rate-limit login/2FA.
- Ajouter décorateurs/middlewares pour vérifier CSRF hors HTMX; tests sécurité (`backend/tests/test_services.py`).

4) Modèles + migrations + CRUD admin
- Créer modèles User/Theme/Content + migrations Alembic; services CRUD; routes admin + templates (listing/edition minimal).
- Tests repo/service + routes admin, incluant rôles et i18n/theme.

5) 2FA TOTP optionnel
- Stocker secret par utilisateur (colonne dédiée, hashing/chiffrement si dispo), activer flux d'activation/validation.
- Tests: génération secret, validation code, rate-limit.

6) Backup/restore pipeline + footer
- Scripts/services de backup (manifest+checksum) et restore avec snapshot pré-restore + dry-run.
- Vérifier/ajouter attribution AGPL dans footer layout.
- Tests intégration (backup/restore happy+erreur) et couverture footer.

## Décisions / recommandations
- Prioriser SQLite pour restore/seed immédiat; ajouter hooks DB vendors plus tard.
- Utiliser HTMX pour feedback progression wizard; éviter JS custom sauf besoin minimal.
- Conserver politique mot de passe forte existante et la partager entre wizard et auth.
- Stockage TOTP: prévoir abstraction pour chiffrement ultérieur; garder secrets hors logs.
- Throttling: limiter login/2FA par IP+user; réessayer après délai.

## Risques & mitigations
- Intégrité backup/restore: exiger manifest+checksum et snapshot pré-restore; logs sans PII.
- Régression wizard: couvrir flux heureux/erreurs avant de retirer tests temporaires.
- Sécurité auth: CSRF hors HTMX, cookies sécurisés, pas de fuite de secrets dans logs.
- Charge future: abstraire I/O backup pour changer de backend (local/S3) sans refonte.

## Actions prochaines (courtes)
- [ ] Finaliser restore/seed réel + progression/erreurs HTMX; MAJ tests wizard.
- [ ] Ajouter auth HTMX (login/logout) avec throttling; tests client.
- [ ] Configurer cookies + CSRF + rate-limit; tests sécurité.
- [ ] Créer modèles/migrations User/Theme/Content + CRUD admin minimal; tests.
- [ ] Activer TOTP optionnel + tests; renforcer footer attribution.
- [ ] Implémenter backup/restore pipeline + tests intégration.

## Commandes de vérification proposées
```bash
ruff check .
ruff format --check .
mypy backend/src
pytest -q
npm run lint
npm run fmt -- --check
```

